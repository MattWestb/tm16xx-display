#!/bin/bash

set -e

display_init() {
	cat /sys/class/leds/display/max_brightness > /sys/class/leds/display/brightness

	echo timer > /sys/class/leds/display::colon/trigger

	echo usbport > /sys/class/leds/display::usb/trigger
	for port in /sys/class/leds/display::usb/ports/*; do
		echo 1 > $port
	done

	echo netdev > /sys/class/leds/display::lan/trigger
	echo eth0 > /sys/class/leds/display::lan/device_name
	echo 1 > /sys/class/leds/display::lan/link

	echo netdev > /sys/class/leds/display::wlan/trigger
	echo wlan0 > /sys/class/leds/display::wlan/device_name
	echo 1 > /sys/class/leds/display::wlan/link
}

display_update() {
	date +%H%M > /sys/class/leds/display/display_value
}

display_cleanup() {
	kill %1
	echo none > /sys/class/leds/display::colon/trigger
	echo none > /sys/class/leds/display::usb/trigger
	echo none > /sys/class/leds/display::lan/trigger
	echo none > /sys/class/leds/display::wlan/trigger
	echo > /sys/class/leds/display/display_value
	echo 0 > /sys/class/leds/display/brightness
}


trap display_cleanup SIGHUP SIGTERM SIGQUIT SIGKILL SIGINT

display_init

while true; do
	display_update
	sleep $((60-$(date +%S)))
done
